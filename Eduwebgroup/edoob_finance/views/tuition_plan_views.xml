<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <record id="tuition_plan_view_tree" model="ir.ui.view">
    <field name="name">tuition.plan.view.tree</field>
    <field name="model">tuition.plan</field>
    <field name="arch" type="xml">
      <tree string="Tuition Plans">
        <field name="name"/>
        <field name="student_id"/>
        <field name="next_installment_date"/>
      </tree>
    </field>
  </record>

  <record id="tuition_plan_view_form" model="ir.ui.view">
    <field name="name">tuition.plan.view.form</field>
    <field name="model">tuition.plan</field>
    <field name="arch" type="xml">
      <form string="Tuition Plan">
        <field name="active" invisible="1"/>
        <field name="id" invisible="1"/>
        <field name="posted_before" invisible="1"/>
        <field name="company_id" invisible="1"/>
        <field name="currency_id" invisible="1"/>
        <header>
          <button name="button_confirm" type="object"
                  string="Confirm" attrs="{'invisible': [('state', '!=', 'draft')]}"/>
          <button name="button_draft" type="object"
                  string="Reset to draft" attrs="{'invisible': [('state', '!=', 'cancel')]}"/>
          <button name="button_cancel" type="object"
                  string="Cancel" attrs="{'invisible': [('state', '!=', 'posted')]}"/>
          <button name="button_create_charge" type="object"
                  groups="sales_team.group_sale_manager"
                  confirm="This will create charges for the next installment!"
                  string="Create charges" attrs="{'invisible': [('state', '!=', 'posted')]}"/>
          <button name="open_update_values_wizard" type="object"
                  confirm="This can overwrite user modifications!"
                  groups="sales_team.group_sale_salesman"
                  string="Update values" />
          <field name="state" widget="statusbar"/>
        </header>
        <sheet>
          <widget name="web_ribbon" title="Archived" bg_color="bg-danger"
                  attrs="{'invisible': [('active', '=', True)]}"/>

          <div class="oe_button_box" name="button_box">
            <button name="action_view_sale_order" type="object" class="oe_stat_button" icon="fa-usd"
                    attrs="{'invisible': [('sale_order_count', '=', 0)]}">
              <field name="sale_order_count" widget="statinfo" string="Sales"/>
            </button>
            <button name="action_view_account_move" type="object" class="oe_stat_button" icon="fa-pencil-square-o"
                    attrs="{'invisible': [('account_move_count', '=', 0)]}">
              <field name="account_move_count" widget="statinfo" string="Invoices"/>
            </button>
          </div>

          <div class="oe_title" attrs="{}">
            <label for="name" class="oe_edit_only"/>
            <h1 attrs="{'invisible': [('posted_before', '=', False)]}">
              <field name="name" attrs="{'readonly': [('state', '!=', 'draft')]}"/>
            </h1>
            <h1 attrs="{'invisible': [('posted_before', '!=', False)]}">New</h1>
          </div>
          <group>
            <group name="left_group">
              <field name="student_id" attrs="{'readonly': [('state', '!=', 'draft')]}"/>
              <field name="tuition_template_id" attrs="{'readonly': [('state', '!=', 'draft')]}"/>
              <field name="next_installment_id"/>
              <field name="student_grade_level_ids" widget="many2many_tags"/>
            </group>
            <group name="right_group">
              <label for="pricelist_option" groups="product.group_product_pricelist"/>
              <div groups="product.group_product_pricelist" class="o_row">
                <field name="pricelist_option" attrs="{'readonly': [('state', '!=', 'draft')]}" />
                <button type="object" name="update_prices"
                  string=" Update Prices"
                  help="Recompute all prices based on this pricelist"
                  class="btn-link mb-1 px-0" icon="fa-refresh"
                  confirm="This will update all unit prices based on the currently set pricelist."
                  attrs="{'invisible': [('state', 'in', ['posted','cancel'])]}"/>
              </div>
              <field name="pricelist_id"
                     attrs="{'invisible': [('pricelist_option', '!=', 'fixed_pricelist')], 'required': [('pricelist_option', '=', 'fixed_pricelist')], 'readonly': [('state', '!=', 'draft')]}" />
              <field name="currency_id" attrs="{'readonly': [('state', '!=', 'draft')]}"
                     groups="base.group_multi_currency"/>
              <field name="company_id" attrs="{'readonly': [('state', '!=', 'draft')]}"
                     groups="base.group_multi_company"/>
              <!--              <field name="program_id" groups="school.group_school_multi_program"/>-->
              <field name="program_id" attrs="{'readonly': [('state', '!=', 'draft')]}"/>
              <field name="journal_id" attrs="{'readonly': [('state', '!=', 'draft')]}"/>
              <field name="payment_term_id" attrs="{'readonly': [('state', '!=', 'draft')]}"/>
              <field name="merge_group_color" widget="color_picker"/>
            </group>
          </group>
          <notebook>
            <page name="lines" string="Lines">
              <field name="line_ids"
                     context="{'default_currency_id': currency_id, 'default_journal_id': journal_id, 'default_tuition_plan_id': id}"
                     attrs="{'readonly': ['|', ('id', '=', False), ('state', '!=', 'draft')]}"
                     options="{'no_open': True}" >
                <tree editable="bottom">
                  <field name="sequence" widget="handle"/>
                  <field name="company_id" invisible="1"/>
                  <field name="template_installment_ids" invisible="1"/>
                  <field name="plan_installment_ids" invisible="1"/>
                  <field name="plan_pricelist_option" invisible="1"/>
                  <field name="plan_pricelist_id" invisible="1"/>
                  <field name="student_families" invisible="1"/>
                  <field name="product_id" optional="show"/>
                  <field name="name" widget="section_and_note_text"/>

                  <field name="installment_ids"
                         context="{'default_tuition_plan_id': parent.id}"
                         attrs="{'readonly': [('form_create_mode', '=', True)]}"
                         widget="many2many_tags" optional="show"/>

                  <field name="account_id" groups="account.group_account_readonly"
                         options="{'no_create': True}"
                         domain="[('deprecated', '=', False), ('user_type_id.type', 'not in', ('receivable', 'payable')), ('company_id', '=', company_id), ('is_off_balance', '=', False)]"/>
                  <field name="analytic_account_id"
                         attrs="{'column_invisible': [('parent.invoice_method', 'not in', ['move'])]}"
                         groups="analytic.group_analytic_accounting" optional="show"/>
                  <field name="analytic_tag_ids" string="Analytic tags" widget="many2many_tags"
                         groups="analytic.group_analytic_tags" optional="show"/>
                  <field name="quantity"/>
                  <field name="unit_price"
                         widget="edoob_finance_family_prices" />
                  <field name="journal_id" optional="hide"/>
                  <field name="template_line_id" invisible="1"/>
                  <field name="currency_id" groups="base.group_multi_currency" optional="hide"/>
                  <field name="form_create_mode" invisible="1"/>
                  <field name="tax_ids"
                         domain="[('type_tax_use','=','sale'), ('company_id','=',parent.company_id), ('country_id', '=', parent.tax_country_id)]"
                         widget="many2many_tags"/>
                  <field name="discount" string="Disc.%" groups="product.group_discount_per_so_line"
                         attrs="{'column_invisible': [('parent.pricelist_option', '=', 'invoice_address')]}"
                         optional="show" widget="product_discount"/>
                  <field name="price_subtotal" widget="monetary"
                         groups="account.group_show_line_subtotals_tax_excluded" optional="show"/>
                  <field name="price_total" widget="monetary" groups="account.group_show_line_subtotals_tax_included"
                         optional="show"/>
                </tree>
              </field>
              <group name="note_group" col="6" class="mt-2 mt-md-0">
                  <group class="oe_subtotal_footer oe_right" colspan="2" name="sale_total">
                      <field name="tax_totals_json" widget="account-tax-totals-field" nolabel="1" colspan="2"/>
                  </group>
                  <div class="oe_clear"/>
              </group>
            </page>
            <page name="installments" string="Installments">
              <field name="installment_ids" attrs="{'readonly': [('state', '!=', 'draft')]}">
                <tree>
                  <field name="sequence" widget="handle"/>
                  <field name="name"/>
                  <field name="type"/>
                  <field name="month"/>
                  <field name="day_type"/>
                  <field name="day_of_the_month"/>
                  <field name="real_date"/>
                  <field name="template_installment_id" invisible="1" force_save="1"/>
                </tree>
              </field>
            </page>
            <page name="recurring_options" string="Recurring options">
              <group>
                <group string="Sales">
                  <field name="invoice_method"/>
                  <field name="post_action_option"/>
                </group>
                <group string="Accounting">
                  <field name="fiscal_position_id"/>
                  <field name="tax_country_id"/>
                  <field name="analytic_account_id"
                         groups="analytic.group_analytic_accounting"
                         attrs="{'readonly': [('state', '!=', 'draft')], 'invisible': [('invoice_method', 'not in', ['sale'])]}"/>
                </group>
                <group string="Mailing">
                  <field name="sale_mail_template_id"/>
                  <field name="invoice_mail_template_id"/>
                </group>
                <group string="Tuition plan">
                  <field name="plan_year" />
                </group>
              </group>
            </page>
            <page name="discounts" string="Discounts" invisible="1">
            </page>
          </notebook>
        </sheet>
        <div class="oe_chatter">
          <field name="message_follower_ids" groups="base.group_user"/>
          <field name="activity_ids"/>
          <field name="message_ids"/>
        </div>
      </form>
    </field>
  </record>

  <record id="tuition_plan_view_kanban" model="ir.ui.view">
    <field name="name">tuition.plan.view.kanban</field>
    <field name="model">tuition.plan</field>
    <field name="arch" type="xml">
      <kanban>
        <field name="student_id"/>
        <field name="name"/>
        <field name="merge_group_color"/>
        <templates>
          <t t-name="kanban-box">
            <div
              t-attf-class="{{!selection_mode ? 'oe_kanban_color_' + kanban_getcolor(record.merge_group_color.raw_value) : ''}} container o_kanban_record_has_image_fill oe_kanban_card oe_kanban_global_click">
              <div class="o_kanban_image">
                <img t-att-src="kanban_image('school.student', 'image_128', record.student_id.raw_value)" alt="Student"
                     class="o_image_64_contain"/>
              </div>
              <div class="o_dropdown_kanban dropdown" >
                <a role="button" class="dropdown-toggle o-no-caret btn" data-toggle="dropdown" data-display="static"
                   href="#" aria-label="Dropdown menu" title="Dropdown menu">
                  <span class="fa fa-ellipsis-v"/>
                </a>
                <div class="dropdown-menu" role="menu">
                  <a class="dropdown-item" role="menuitem" type="edit">Edit</a>
                  <div role="separator" class="dropdown-divider"></div>
                  <ul class="oe_kanban_colorpicker" data-field="merge_group_color"/>
                </div>
              </div>
              <div class="oe_kanban_details p-2 d-flex">
                <div class="o_kanban_record_top w-100 " style="justify-content: space-between;">
                  <div class="o_kanban_record_headings">
                    <strong class="o_kanban_record_title">
                      <div>
                        <strong><span t-esc="record.name.value"/></strong>
                      </div>
                    </strong>
                    <div class="o_kanban_tags_section">
<!--                      <field name="product_template_attribute_value_ids" groups="product.group_product_variant"-->
<!--                             widget="many2many_tags" options="{'color_field': 'color'}"/>-->
                    </div>
                    <ul>
                      <li>
                        <field name="student_id"/>
                      </li>
                      <li>
                        <strong>
                          Total: <field name="amount_total" options="{'currency_field': 'currency_id'}"/>
                        </strong>
                      </li>
                      <field name="currency_id" invisible="True"/>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </t>
        </templates>
      </kanban>
    </field>
  </record>

  <record id="tuition_plan_view_search" model="ir.ui.view">
    <field name="name">tuition.plan.view.search</field>
    <field name="model">tuition.plan</field>
    <field name="arch" type="xml">
      <search string="Search Tuition Plans">
        <field name="name"/>
        <separator/>
        <filter string="Archived" name="inactive" domain="[('active','=',False)]"/>

        <filter name="group_by_state" string="State" context="{'group_by': 'state'}"/>
        <filter name="group_by_grade_levels" string="Grade levels"
                context="{'group_by': 'student_grade_level_ids'}"/>
        <filter name="group_by_next_installment_dates" string="Next Installment Date"
                context="{'group_by': 'next_installment_date'}"/>
      </search>
    </field>
  </record>

  <record id="tuition_plan_action" model="ir.actions.act_window">
    <field name="name">Tuition Plans</field>
    <field name="res_model">tuition.plan</field>
    <field name="view_mode">kanban,tree,form</field>
    <field name="target">current</field>
    <field name="context">{}</field>
  </record>

  <menuitem
          id="tuition_plan_menu"
          name="Tuition Plans"
          action="tuition_plan_action"
          parent="tuition_management_menu"
          sequence="10"/>

  <!-- Family prices -->
  <record id="tuition_plan_family_prices_view_tree" model="ir.ui.view">
    <field name="name">tuition.plan.family.prices.view.tree</field>
    <field name="model">tuition.plan.family.prices</field>
    <field name="arch" type="xml">
      <tree string="Tuition Plans" create="0" edit="0" >
        <field name="family_id" widget="many2one"/>
        <field name="price" />
        <field name="discount" string="Disc.%" groups="product.group_discount_per_so_line"/>
      </tree>
    </field>
  </record>

</odoo>